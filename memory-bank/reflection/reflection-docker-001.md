# Рефлексия: docker-001 — Реализовать Docker в проекте

**Task ID:** docker-001  
**Уровень:** Level 3 (Intermediate Feature)  
**Дата:** 2025-02-18

---

## Краткое содержание

Добавлена полная поддержка Docker: один образ для всех блоков (spambot, post_flow и др.), сборка через Dockerfile, опциональный docker-compose, документация в docs/guides/DOCKER.md. Секреты не попадают в образ (--env-file, volumes). Образ успешно собирается и запускается; проверка: `docker run --rm --env-file .env contentzavod python -m blocks.spambot --list-projects`.

---

## Что получилось хорошо

- **Единый образ и разный command** — стратегия «один образ, много entry points» совпала с мультипроектностью и не потребовала креативной фазы.
- **План (PLAN)** — чёткий чеклист в tasks.md позволил выполнить build по шагам без пропусков.
- **Документация** — DOCKER.md сразу включил типичные кейсы (сборка, запуск, compose, путь к .env, виртуализация, ограничение Playwright).
- **Правила проекта** — исключения для Dockerfile/.dockerignore/docker-compose в project-structure.mdc добавлены без конфликта с правилом «ничего в корне».
- **Проверка на реальной среде** — после установки Docker Desktop и включения виртуализации образ собрался и контейнер вывел список проектов.

---

## Сложности и как их обошли

1. **Docker не установлен / не в PATH**  
   Пользователь получил «docker не является командой». Запущена установка через winget; при сбое с кодом 3 в гайд добавлен ручной установщик и раздел про путь к .env.

2. **«Virtualization support not detected» в Docker Desktop**  
   Включены компоненты Windows (VirtualMachinePlatform, WSL); в DOCKER.md добавлена пошаговая инструкция: dism, перезагрузка, wsl --update, проверка в диспетчере задач и BIOS.

3. **Конфликт зависимостей при сборке образа**  
   googletrans==4.0.0-rc1 требует httpx==0.13.3, а mcp и python-telegram-bot — httpx>=0.27. Решение: отдельный **requirements-docker.txt** (без mcp); в образе вместо googletrans используется **deep-translator**. В newsbot порядок инициализации переводчика изменён на «сначала deep_translator, затем googletrans» — в контейнере работает deep_translator, на хосте по-прежнему можно использовать оба.

4. **Ошибка «open .env: The system cannot find the file specified»**  
   Команда запускалась не из корня проекта. В гайд добавлено: запускать docker run из каталога КонтентЗавод или указывать полный путь к .env в --env-file.

---

## Уроки

- При добавлении Docker в существующий проект **сразу проверять совместимость зависимостей** (pip install -r requirements.txt в чистом окружении или в образе); конфликты httpx/переводчиков лучше выявлять на этапе плана или в начале build.
- **Отдельный requirements-docker.txt** удобен, когда в основном requirements есть пакеты только для хоста (например mcp) или несовместимые версии; документировать отличия в комментариях в файле.
- Для Windows-пользователей в гайд стоит сразу включать: установку Docker (в т.ч. при коде 3), включение виртуализации/WSL, **запуск из корня проекта** и путь к .env.

---

## Улучшения процесса и техники

- **Проверка сборки в build-фазе:** при доступном Docker запускать `docker build` в рамках build, а не оставлять только «проверьте у себя»; при недоступности Docker — явно фиксировать в progress.md.
- **Регрессия на хосте:** замена приоритета переводчика (deep_translator первым) не ломает локальный запуск: если установлен googletrans, он остаётся запасным; если только deep_translator — он используется и в контейнере, и на хосте.
- **Memory Bank:** фазы van → plan → build → reflect прошли последовательно; рефлексия зафиксировала не только «что сделано», но и обход типичных проблем (установка Docker, виртуализация, зависимости, путь к .env), что полезно для архива и следующих задач.

---

## Рекомендации на будущее

- При необходимости запускать **autopost_zen** (Playwright) в контейнере — оформить отдельную задачу: образ на базе playwright или multi-stage Dockerfile с браузером.
- При появлении новых блоков с тяжёлыми или конфликтующими зависимостями — при необходимости расширять requirements-docker.txt и сохранять комментарии о расхождениях с основным requirements.txt.
