# Архитектура проекта «ContentZavod»

## Обзор

**ContentZavod** — система автоматизированного создания и распространения контента в социальных сетях. Суть архитектуры: **вся работа разбита на независимые блоки**, каждый формирует часть конечного продукта. Новый блок можно добавить в любой момент без изменения существующего кода.

---

## Ключевые принципы

### 1. Модульность (Plug-in Architecture)
- Каждый блок — **независимый модуль** со своим интерфейсом
- Блоки общаются только через **единый контракт данных** (ContentItem)
- Добавление нового блока = создание нового файла/папки, регистрация в реестре

### 2. Расширяемость
- Новый блок не трогает старые блоки
- Можно включать/отключать блоки через конфигурацию
- Порядок выполнения блоков задаётся в пайплайне

### 3. Единый контракт данных
- Вся система работает с **ContentItem** — унифицированной структурой контента
- Каждый блок получает ContentItem, обогащает его и возвращает обновлённый

---

## Ядро системы

### ContentItem (Единая модель контента)

```
ContentItem:
├── id: str
├── title: str
├── body: str (основной текст)
├── images: List[ImageData]
├── keywords: List[str]
├── hashtags: List[str]
├── metadata: Dict (расширяемые данные)
├── variants: Dict[platform, adapted_content]  # адаптации под площадки
├── status: str (draft | ready | published | failed)
├── timestamps: Dict
└── source: str (откуда создан)
```

### Pipeline (Оркестратор)
- Управляет последовательностью блоков
- Передаёт ContentItem от блока к блоку
- Обрабатывает ошибки, повторные попытки
- Поддерживает ветвления (например: один контент → несколько постов под площадки)

### Block Registry (Реестр блоков)
- Центральный каталог всех доступных блоков
- Каждый блок регистрирует себя: имя, входы, выходы, зависимости
- Загрузка блоков по требованию

---

## Мультипроектность

Один ContentZavod обслуживает **несколько проектов** (бизнесов). У каждого проекта свои аккаунты в соцсетях и настройки ботов; **API ИИ общий** и задаётся в `.env`.

- **Блок «Проекты»** (`blocks/projects/`) хранит конфигурацию по каждому проекту в YAML (`data/<project_id>.yaml`).
- При запуске бота указывается проект: `start.bat flowcabinet` или `python -m blocks.spambot --project flowcabinet`. Подставляются токены и настройки из конфига проекта.
- Общее (в `.env`): `GRS_AI_API_KEY`, `PROJECT_ID` (проект по умолчанию). Проектное (в YAML): Telegram, VK, Дзен, CTA, хештеги, RSS и т.д.

Подробнее: **docs/guides/MULTIPROJECT.md**.

---

## Категории блоков

### A. Контент-блоки (создание и обработка)
### B. Интеграционные блоки (внешние API)
### C. Адаптационные блоки (под конкретную площадку)
### D. Публикационные блоки (постинг)
### E. Инфраструктурные блоки (общие сервисы, в т.ч. проекты)

---

## Описание блоков

### 1. [A] Создание контента (Content Creation)

| Подблок | Вход | Выход | Описание |
|---------|------|-------|----------|
| Генерация заголовков | тема, контекст | List[str] заголовков | Генерация вариантов заголовков |
| Генерация текста статьи | тема, заголовок | body | Генерация основного текста |
| Генерация картинок | тема, контекст | List[ImageData] | Генерация/подбор изображений |
| SEO-оптимизация | title, body | keywords, оптимизированный текст | Подбор ключевых слов, доработка текста |
| Генерация хештегов | keywords, контекст | List[str] хештегов | Хештеги на основе ключевиков |

**Собственные правила:** длина заголовка, тон голоса, стиль, водяные знаки, ограничения по формату.

---

### 2. [B] Интеграции по API с ИИ

| Назначение | Описание |
|------------|----------|
| OpenAI API | GPT, DALL-E для текста и картинок |
| YandexGPT | Альтернатива для текста |
| Kandinsky / др. | Генерация изображений |
| Единый провайдер | Абстракция над разными API, fallback при ошибках |

**Правила:** лимиты запросов, таймауты, retry-логика, кэширование.

---

### 3. [D] Автопостинг — ВКонтакте

- Публикация в группы/паблики
- Адаптация формата: длина, эмодзи, превью
- Поддержка фото, видео, карусели
- Очередь постов, отложенная публикация

**Правила площадки:** лимит длины, требования к изображениям, расписание.

---

### 4. [D] Автопостинг — Дзен

- Публикация статей в Яндекс.Дзен
- Адаптация под формат Дзен (заголовки, подзаголовки, блоки)
- SEO-поля, теги, обложка

**Правила:** структура статьи, лимиты, теги.

---

### 5. [D] Автопостинг — Pinterest

- Публикация пинов
- Адаптация: вертикальные изображения, описания, доски
- Хештеги и ссылки

**Правила:** соотношение сторон, длина описания, формат ссылок.

---

### 6. [D] Автопостинг — vc.ru

- Публикация статей на vc.ru
- Формат markdown, теги, обложка
- Адаптация под аудиторию vc.ru

**Правила:** стиль, длина, теги.

---

### 7. [D] Автопостинг — Telegram

- Публикация в каналы
- Поддержка медиа, форматирование (Markdown/HTML)
- Отложенные посты

**Правила:** лимит символов, эмодзи, превью.

---

## Дополнительные блоки (рекомендуемые)

### 8. [E] Планировщик (Scheduler)
- Очередь публикаций
- Расписание по времени и площадкам
- Учёт лимитов площадок (rate limits)
- Повтор при сбоях

### 9. [E] Хранилище контента (Content Storage)
- Сохранение ContentItem (БД/файлы)
- История версий, черновики
- Поиск и фильтрация

### 10. [E] Логирование и мониторинг
- Логи выполнения блоков
- Метрики (успех/ошибка, время)
- Алерты при сбоях

### 11. [E] Конфигурация и секреты
- Настройки блоков
- API-ключи, токены (без хардкода)
- Профили для разных окружений

### 12. [C] Адаптеры под площадки
- Блок-адаптер на каждую площадку
- Преобразование ContentItem → формат площадки
- Обрезка текста, изменение изображений, добавление полей

### 13. [A] Модерация и валидация
- Проверка контента до публикации
- Фильтрация запрещённого, спама
- Чеклист перед постом

### 14. [E] Веб-интерфейс / API управления
- Создание задач на контент
- Просмотр очереди, истории
- Ручной запуск/пауза блоков

---

## Схема потока данных

```
[Триггер: тема/запрос]
        ↓
[1. Content Creation] → ContentItem (draft)
        ↓
[2. AI Integrations]  → обогащение через API
        ↓
[3. SEO + Hashtags]   → keywords, hashtags
        ↓
[4. Platform Adapters] → variants для каждой площадки
        ↓
[5. Scheduler]        → постановка в очередь
        ↓
[6. Autoposting]      → публикация на ВК, Дзен, Pinterest, vc.ru, Telegram
        ↓
[7. Storage + Logging] → сохранение, логи
```

---

## Структура одного блока

```
blocks/
  vk_autopost/
    __init__.py
    block.py          # логика блока
    config.py         # настройки
    rules.md          # правила площадки
    requirements.txt  # зависимости блока (если есть)
```

**Интерфейс блока:**
```python
class Block(Protocol):
    name: str
    def execute(self, content: ContentItem, context: BlockContext) -> ContentItem: ...
    def validate_config(self) -> bool: ...
```

---

## Технологический стек (рекомендации)

| Слой | Варианты |
|------|----------|
| Язык | Python 3.10+ |
| Очередь задач | Celery, RQ, или встроенная |
| Хранилище | SQLite/PostgreSQL + файлы для медиа |
| Конфиг | YAML/JSON + env |
| Логи | structlog / loguru |
| Контейнеризация | Docker (опционально) |

---

## Порядок разработки

1. **Фаза 1:** Ядро — ContentItem, Pipeline, Block Registry
2. **Фаза 2:** Инфраструктурные блоки (Storage, Config, Logging)
3. **Фаза 3:** AI-интеграции
4. **Фаза 4:** Content Creation
5. **Фаза 5:** Адаптеры и автопостинг по площадкам
6. **Фаза 6:** Scheduler, веб-интерфейс

---

## Версионирование

- Архитектура: v1.0
- Документ обновлён: 2026-02-01
