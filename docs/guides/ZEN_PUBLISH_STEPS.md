# Пошаговые действия при публикации статьи в Дзен

Документ описывает **каждое действие** клиента (`zen_client.py`) при вставке статьи в редактор Дзена. Нужен для отладки «полетевшей» разметки: можно свериться с шагами и понять, на каком этапе ломается вёрстка.

**Важно:** в теле статьи **никогда** не используется `Ctrl+A` (выделение всего) — это ломает блоки. Между блоками — только один `Enter`.

---

## 1. Открытие редактора и заголовок

| Шаг | Действие | Код / примечание |
|-----|----------|-------------------|
| 1.1 | Переход на `CREATE_POST_URL` | `page.goto`, wait 2.5–5 с |
| 1.2 | Ожидание капчи (если есть) | `_wait_captcha_if_present` |
| 1.3 | Закрытие модалки Яндекса | `dismiss_yandex_default_search_modal` |
| 1.4 | 5× Escape | Сброс фокуса/модалок |
| 1.5 | Закрытие попапа донатов | `_dismiss_donation_modal` |
| 1.6 | Открытие редактора новой статьи | `_open_new_article_editor`: клик по «Написать статью» |
| 1.7 | Закрытие подсказки (Понятно/Закрыть и т.д.) | `_dismiss_help_popup` |
| 1.8 | Ожидание полей редактора | `title_field`, `body_editor` |
| 1.9 | Клик по полю заголовка | `editors.nth(0)`, hover → click |
| 1.10 | Очистка поля | **Ctrl+A** (только в заголовке) |
| 1.11 | Ввод заголовка | `keyboard.type(title, delay=35–85)` |
| 1.12 | Пауза 0.5–1.2 с | — |
| 1.13 | Клик по полю тела статьи | `editors.nth(1)` (или nth(0) если одно поле), `click(force=True)` |
| 1.14 | Пауза 0.4–0.9 с | Курсор в начале тела статьи |

После этого курсор находится в **первом блоке** тела статьи (пустой абзац или строка).

---

## 2. Цикл по блокам контента (`content_blocks`)

Блоки идут в порядке: **обложка (картинка)** → текст (HTML) → картинки → текст и т.д.  
Для **каждого** блока:

### 2.0 Перед блоком (если это не первый блок, `i > 0`)

| Шаг | Действие | Примечание |
|-----|----------|------------|
| 2.0.1 | **Один раз нажать Enter** | Создаётся новая строка/блок. Лишних Enter нет (раньше было два для текста — убрано). |
| 2.0.2 | Пауза 0.15–0.3 с | |

Курсор оказывается на **пустой строке** (новый блок).

---

### 2.1 Блок типа `html`

| Шаг | Действие | Примечание |
|-----|----------|------------|
| 2.1.1 | Парсинг HTML | `_parse_html_block(html)` → `block_kind`, `text`, `list_items`. Типы: h2, h3, p, ul, ol, blockquote, p_with_link |
| 2.1.2 | Пауза 0.2–0.5 с | |
| 2.1.3 | Вставка в редактор | `_insert_block_via_editor(block_kind, text, ...)` — см. таблицы ниже по типам |

Дополнительных Enter после блока **не** нажимаем.

#### 2.1.3a Тип `p` (параграф)

| Шаг | Действие |
|-----|----------|
| A | `_paste_text(text)` — clipboard.writeText + **Ctrl+V** (или type с delay 5) |
| B | Пауза 0.2–0.4 с |
| C | Если текст начинается с «ШАГ N.»: **Home** → 5× **Shift+ArrowRight** → клик **[aria-label="Bold"]** → **End** (курсор в конец строки, чтобы Enter не разрезал абзац) |
| D | Если текст — одна строка и заканчивается на `?` (FAQ): **Home** → **Shift+End** (выделить до конца строки, НЕ Shift+ArrowDown!) → клик **Bold** → **End** |
| E | Иначе — ничего (просто параграф) |

#### 2.1.3b Тип `h2`, `h3`, `blockquote`

| Шаг | Действие |
|-----|----------|
| A | `_paste_text(text)` |
| B | Пауза 0.2–0.4 с |
| C | **Home** → **Shift+ArrowDown** (выделить текущую строку) |
| D | Клик по кнопке формата в тулбаре: `[aria-label="Heading 2"]` / `"Heading 3"` / `"Blockquote"` |
| E | **ArrowRight** (снять выделение) |

#### 2.1.3c Тип `ul` или `ol`

| Шаг | Действие |
|-----|----------|
| A | Для первого пункта: `_paste_text(item)` → пауза → **Home** → **Shift+ArrowDown** → клик `[aria-label="ul"]` или `"ol"` → **ArrowRight** |
| B | Для каждого следующего пункта: **Enter** → пауза → `_paste_text(item)` |
| C | Пауза 0.2–0.4 с в конце |

#### 2.1.3d Тип `p_with_link`

| Шаг | Действие |
|-----|----------|
| A | `_paste_html(html_for_paste)` — вставка HTML через буфер (Draft.js может сохранить `<a>`) |

---

### 2.2 Блок типа `image`

Предполагается: перед картинкой уже нажат **один Enter** (шаг 2.0.1), курсор на пустой строке.

| Шаг | Действие | Примечание |
|-----|----------|------------|
| 2.2.1 | Пауза 0.4–0.8 с | «Курсор на пустой строке — кнопка вставки должна появиться» |
| 2.2.2 | Поиск кнопки вставки картинки | `button[data-tip='Вставить изображение']` |
| 2.2.3 | Если есть URL: клик по кнопке → заполнение поля URL → «Добавить»/«Вставить» → ожидание → подпись и выход | |
| 2.2.4 | Если файл: конвертация в JPEG, подготовка payload | `_ensure_jpeg`, `_file_payload` |
| 2.2.5 | Клик по кнопке вставки изображения | `insert_img_btn.click(force=True)` |
| 2.2.6 | Ожидание появления `input[type="file"]` или file chooser | |
| 2.2.7 | Загрузка файла | `set_input_files(files=payload)` или `file_chooser.set_files()` |
| 2.2.8 | Ожидание 8–14 с + 2 с | |
| 2.2.9 | Заполнение подписи и выход из блока | `_fill_caption_and_exit_image_block`: заполнить последний input подписи → **Escape** → **ArrowDown** |

**Выход из блока картинки:** один **Escape**, затем **ArrowDown** (переместить курсор ниже картинки). Больше никаких Enter/ArrowDown здесь не делаем.

---

## 3. После всех блоков

| Шаг | Действие |
|-----|----------|
| 3.1 | Пауза 1–2.5 с после каждого блока (в конце цикла) |
| 3.2 | Установка тегов (если есть) | `_set_tags`: заполнение поля тегов, каждый тег + Enter |
| 3.3 | Клик «Опубликовать» и загрузка обложки | `_click_publish(cover_image=..., cover_image_url=...)` |

---

## 4. Что может ломать разметку (чек-лист)

- **Двойной Enter между блоками** — сейчас только один Enter (исправлено). Если где-то снова два — убрать.
- **Ctrl+A в теле статьи** — нигде не использовать (только в заголовке).
- **Курсор после Bold не в конце строки** — если после Bold курсор остался в середине строки (например, на позиции 6 после «ШАГ 1»), следующий Enter в главном цикле РАЗРЕЖЕТ абзац пополам. Обрезок склеится с другим блоком. **Решение:** после Bold всегда жать **End** (в конец строки).
- **Shift+ArrowDown для Bold** — захватывает начало следующего блока. Bold — inline-формат (не блочный как H3), применяется к точному выделению, включая чужой блок. **Решение:** для Bold использовать **Home → Shift+End** (только до конца текущей строки).
- **После картинки** — только **Escape** и один **ArrowDown**; лишние Enter/клики могут создавать пустые блоки.
- **Списки (ul/ol)** — первый пункт получает формат через Home+Shift+Down+кнопка; остальные — только Enter и ввод текста. Не выделять весь список через Ctrl+A.

---

## 5. Сводка клавиш по типам блоков

| Тип блока | Перед блоком | Вставка текста | После вставки текста |
|-----------|--------------|----------------|----------------------|
| любой (i>0) | **Enter** × 1 | — | — |
| **p** | — | Ctrl+V (paste text) | ШАГ: Home → 5×Shift+Right → Bold → **End**. FAQ: Home → **Shift+End** → Bold → **End** |
| **h2/h3/blockquote** | — | Ctrl+V | Home → Shift+Down → кнопка формата (aria-label) → Right |
| **ul/ol** | — | 1-й пункт: Ctrl+V → Home → Shift+Down → ul/ol → Right; след.: Enter → Ctrl+V | — |
| **p_with_link** | — | _paste_html (HTML в буфер, Ctrl+V) | — |
| **image** | Enter (если i>0) | — | Клик кнопки картинки → файл/URL → подпись → **Escape** → **ArrowDown** |

Файл реализации: `blocks/autopost_zen/zen_client.py` (create_post, _insert_block_via_editor, _format_current_line, _apply_bold_after_paragraph, _add_image_in_article, _fill_caption_and_exit_image_block).
