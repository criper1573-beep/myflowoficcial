# MCP и браузерные инструменты — зачем и как настроить

## MCP ContentZavod (собственный)

Проект имеет встроенный MCP-сервер: **content-factory** (`blocks/mcp_server/`).

**Инструменты:** `zen_publish`, `zen_draft`, `zen_list_articles`.

**Подключение:** в `.cursor/mcp.json` уже добавлен сервер. Установите зависимость:
```bash
pip install "mcp[cli]"
```
После перезапуска Cursor инструменты доступны в Composer (Ctrl+I). См. `blocks/mcp_server/README.md`.

---

Кратко: **MCP не обязателен** для автопостинга (внешние браузерные MCP). Он нужен, если вы хотите, чтобы я мог сам «открыть» сайт (Дзен, vc.ru и т.д.) в браузере и по структуре страницы подбирать селекторы и шаги. Без MCP я опираюсь на ваше описание, документацию и типичные паттерны.

---

## 1. Что такое MCP

**MCP (Model Context Protocol)** — открытый протокол, который даёт AI в Cursor доступ к **внешним инструментам** (не только к коду в проекте).

- **MCP‑сервер** — отдельная программа, которая «общается» с Cursor по протоколу и предоставляет инструменты.
- **Инструменты** — действия, которые я могу вызывать: например, «перейти по URL», «сделать снимок страницы», «нажать на кнопку», «получить HTML».

То есть MCP — это способ **подключить к Cursor дополнительные возможности** (браузер, базы, API и т.д.).

---

## 2. При чём тут браузер и автопостинг

В промпте «Универсальный автопост» было написано: исследовать площадку **через MCP browser tools**. Имелось в виду:

- Я (как агент) могу **открыть** в браузере, например, zen.yandex.ru.
- **Перейти** на страницу входа и на страницу создания статьи.
- **Получить снимок DOM** (структуру страницы: какие поля, кнопки, классы).
- По этому снимку точнее предложить **селекторы и шаги** для Playwright (куда кликать, что вводить, как найти кнопку «Опубликовать»).

**Если MCP с браузером нет:** я всё равно могу писать скрипт автопостинга, опираясь на:
- ваше описание («захожу сюда, нажимаю туда»);
- типичные схемы сайтов (форма логина, редактор с contenteditable и т.д.);
- публичную документацию Дзена/других площадок.

Итог: **MCP с браузером — это удобное дополнение**, а не обязательное условие.

---

## 3. Нужно ли это лично вам

| Ситуация | Рекомендация |
|----------|----------------|
| Хотите, чтобы я сам «посмотрел» Дзен/vc.ru и предложил точные селекторы | Имеет смысл настроить MCP с браузером. |
| Готовы один раз описать/показать (скрин, шаги), как вы заходите и создаёте статью | MCP не обязателен, можно обойтись без него. |
| Планируете много разных площадок и хотите минимизировать ручное описание | MCP браузер полезен. |

---

## 4. Как настроить MCP с браузером в Cursor

### 4.1. Общая схема

1. Установить **Node.js 18+** (если ещё нет): https://nodejs.org/
2. В Cursor включить и настроить MCP: добавить **MCP‑сервер**, который даёт браузерные инструменты (Puppeteer или аналог).
3. После этого в чате/Composer у меня появятся инструменты вроде «перейти по URL», «снимок страницы» и т.д. (если разработчики сервера их так назвали).

### 4.2. Где настраивается MCP в Cursor

- **Cursor Settings** → **Features** → **MCP** (или **Cursor Settings** → **MCP**).
- Кнопка **«+ Add New MCP Server»** (или **«Add server»**).
- Нужно указать:
  - **имя** сервера (например, `browser`);
  - **тип транспорта**: обычно **stdio** (запуск локальной команды);
  - **команда запуска** MCP‑сервера (см. ниже).

Конфиг может храниться в файле, например:
- Windows: `%USERPROFILE%\.cursor\mcp.json`
- или в настройках Cursor (UI).

### 4.3. Рекомендуемый сервер: Playwright MCP (официальный, Microsoft)

Используйте **@playwright/mcp** — официальный MCP‑сервер от Microsoft. Puppeteer MCP помечен как deprecated.

- **Пакет:** `@playwright/mcp` (npm)
- **Команда запуска:** `npx @playwright/mcp@latest`
- При первом использовании может скачаться браузер Chromium (через Playwright).

### 4.4. Пошаговая настройка (Cursor 2.4, Windows 11)

1. **Node.js уже установлен** (у вас 22.21.1) — достаточно.

2. **Откройте настройки MCP в Cursor:**
   - Меню **File** → **Preferences** → **Cursor Settings** (или **Ctrl+Shift+J** / иконка шестерёнки в левом нижнем углу).
   - В левой панели найдите раздел **Features** → **MCP** (или просто **MCP**).

3. **Добавьте новый MCP‑сервер:**
   - Нажмите **«+ Add New MCP Server»** (или **«Add server»**).
   - **Name (имя):** например `Playwright` или `browser`.
   - **Type (тип):** выберите **Command** (или **stdio** — запуск локальной команды).
   - **Command (команда):** укажите:
     ```text
     npx @playwright/mcp@latest
     ```
   - Если есть поле **Arguments** (аргументы), можно оставить пустым или добавить при необходимости, например:
     ```text
     @playwright/mcp@latest
     ```
     (при использовании `npx` пакет уже передаётся в команде.)
   - Сохраните (OK / Save).

4. **Проверка:** перезапустите Cursor (закройте и откройте снова), чтобы MCP‑сервер подхватился.

5. **Установка браузера для Playwright (если попросит):**  
   При первом использовании Playwright MCP может потребовать установить браузер. В чате Composer можно вызвать инструмент **browser_install**, либо в терминале выполнить:
   ```bash
   npx playwright install chromium
   ```

6. **Где работают инструменты:** откройте **Composer** (режим агента: Ctrl+I или кнопка в панели). В этом режиме должны быть доступны инструменты Playwright MCP: `browser_navigate`, `browser_snapshot`, `browser_click`, `browser_type` и др.

**Если MCP не появляется в списке:** убедитесь, что в настройках MCP сервер включён (галочка/переключатель). На Windows путь к конфигу может быть: `%USERPROFILE%\.cursor\config\mcp.json` — при добавлении через UI Cursor сам создаёт или обновляет конфиг.

### 4.5. Другие варианты

- **BrowserTools MCP**, **Puppeteer MCP** (deprecated) — при необходимости ищите в каталогах MCP‑серверов.
- Документация Cursor по MCP: https://docs.cursor.com/context/model-context-protocol  
- Документация Playwright MCP: https://www.npmjs.com/package/@playwright/mcp

Важно: **MCP‑инструменты обычно доступны в Composer (агентском режиме)**, а не в обычном чате. Если после настройки инструментов не видно — откройте Composer (Ctrl+I) и проверьте, что выбран модель с поддержкой инструментов.

### 4.6. Рекомендуемые аргументы при «зависании» на about:blank (Windows)

Если браузер открывается, но остаётся на `about:blank` и навигация таймаутит, в **%USERPROFILE%\\.cursor\\mcp.json** в `args` для Playwright можно добавить:

| Аргумент | Назначение |
|----------|------------|
| `--isolated` | Сессия без сохранения профиля на диск; устраняет блокировку профиля и лишние вкладки about:blank при повторных запусках. |
| `--timeout-navigation`, `120000` | Таймаут навигации 2 минуты (по умолчанию 60 с); помогает на медленных или тяжёлых страницах. |
| `--no-sandbox` | Отключает песочницу; иногда нужен на Windows, если браузер не стартует или зависает. |

Пример фрагмента `mcp.json`:

```json
"playwright": {
  "command": "npx",
  "args": [
    "-y",
    "@playwright/mcp@latest",
    "--isolated",
    "--timeout-navigation",
    "120000",
    "--no-sandbox"
  ]
}
```

После правки **полностью закройте Cursor** и откройте снова (не только перезагрузка окна).

---

## 4.7. MCP для веб-исследований (поиск по интернету, в т.ч. китайскому)

Чтобы я мог **автоматически искать информацию в интернете**, открывать страницы и извлекать текст (в т.ч. с китайских сайтов), нужны:

| MCP | Назначение | Как подключен |
|-----|------------|----------------|
| **fetch** | Загрузка страницы по URL и конвертация HTML → markdown | В `%USERPROFILE%\\.cursor\\mcp.json` добавлен сервер `fetch` (команда: `py -m mcp_server_fetch`). Требуется: `py -m pip install mcp-server-fetch`. |
| **playwright** | Браузер: навигация, поиск в Baidu/других поисковиках, снимок DOM, клики | Уже в `mcp.json` (см. п. 4.3–4.6). |
| **Cursor IDE Browser** (опционально) | Браузер внутри Cursor: вкладки, снимки, поиск | Включается в **Cursor Settings → MCP** или через расширения Cursor. |

**Сценарий использования:** вы просите «найди всю информацию о сервисе X, владельцах и схеме работы». Я делаю веб-поиск (встроенный в Cursor), по результатам вызываю **fetch** для загрузки нужных URL и при необходимости открываю сайты через **playwright** или Cursor IDE Browser, затем собираю и структурирую ответ.

**Проверка fetch:** после перезапуска Cursor в Composer (Ctrl+I) должен появиться инструмент вроде `fetch` (один URL — один вызов). Если сервер не стартует, проверьте: `py -m mcp_server_fetch` запускается без ошибок в терминале.

---

## 5. Устранение неполадок

### Браузер открывается, но висит на about:blank / навигация таймаутит

1. **Закройте все старые экземпляры браузера Playwright**  
   В диспетчере задач завершите процессы `chromium`, `chrome` или с путём `ms-playwright`, если они остались от предыдущего запуска Cursor или MCP.

2. **Используйте режим `--isolated`**  
   В `%USERPROFILE%\\.cursor\\mcp.json` добавьте в `args` сервера Playwright аргумент `--isolated`. Тогда профиль не пишется на диск и не блокируется между сессиями (см. п. 4.6 выше).

3. **Увеличьте таймаут навигации**  
   Добавьте `--timeout-navigation` и `120000` (или больше) в `args`, если страница открывается долго.

4. **Попробуйте `--no-sandbox`**  
   На части машин Windows с ограничениями песочница мешает запуску; добавление `--no-sandbox` в `args` может помочь.

5. **Антивирус / фаервол**  
   Временно отключите или добавьте в исключения: Cursor, Node.js, npx, каталог `%USERPROFILE%\\AppData\\Local\\ms-playwright` и браузеры Playwright. После проверки MCP можно снова включить и при необходимости сузить исключения.

6. **Переустановка браузера Playwright**  
   В терминале выполните:
   ```bash
   npx playwright install chromium --force
   ```
   Затем перезапустите Cursor.

7. **Проверка без MCP**  
   Убедитесь, что Playwright вообще работает на системе:
   ```bash
   npx playwright install chromium
   npx -y @playwright/mcp@latest --isolated --no-sandbox
   ```
   В другом терминале или через тестовый скрипт можно проверить навигацию; если здесь всё ок, а в Cursor — нет, причина может быть в таймаутах клиента (Cursor) или в том, что MCP-сервер перезапускается.

### MCP-инструменты не видны в Composer

- Откройте именно **Composer** (Ctrl+I), не обычный чат.
- В настройках MCP убедитесь, что сервер Playwright **включён** (галочка).
- Полностью закройте и снова откройте Cursor после изменения `mcp.json`.

---

## 6. Кратко

- **MCP** — способ дать AI в Cursor доступ к внешним инструментам (в т. ч. к браузеру).
- **MCP browser** в контексте автопостинга — чтобы я мог сам открыть сайт и по структуре страницы предлагать селекторы и шаги для Playwright.
- **Для автопостинга MCP не обязателен**: можно описать шаги и интерфейс словами/скринами, и я напишу скрипт по гайду [PLAYWRIGHT_AUTOPOST.md](PLAYWRIGHT_AUTOPOST.md).
- **Если хотите включить MCP браузер:** установите Node.js, в Cursor: **Cursor Settings** → **MCP** → **Add New MCP Server** → имя `Playwright`, тип **Command**, команда `npx @playwright/mcp@latest`. Перезапустите Cursor. В **Composer** (Ctrl+I) появятся браузерные инструменты. При первом использовании при необходимости выполните `npx playwright install chromium`.
